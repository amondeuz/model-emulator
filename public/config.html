<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Puter Model Emulator</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; background: #f4f6f8; margin: 0; padding: 20px; color: #1f2933; }
    .container { max-width: 840px; margin: 0 auto; background: #fff; border-radius: 12px; padding: 28px; box-shadow: 0 12px 40px rgba(0,0,0,0.06); }
    h1 { margin: 0 0 6px; font-size: 24px; }
    .muted { color: #627384; font-size: 14px; margin: 0; }
    .section { margin-top: 18px; }
    label { display: block; font-weight: 600; margin-bottom: 6px; }
    input[type="text"], select { width: 100%; padding: 11px 12px; border: 1px solid #d9e1ec; border-radius: 10px; font-size: 14px; }
    input:focus, select:focus { outline: none; border-color: #4a9eff; box-shadow: 0 0 0 3px rgba(74,158,255,0.15); }
    select { max-height: 300px; overflow-y: auto; }
    .row { display: flex; gap: 10px; align-items: center; }
    .row > *:first-child { flex: 1; }
    button { border: none; border-radius: 10px; padding: 11px 16px; font-weight: 600; cursor: pointer; font-size: 14px; }
    .primary { background: #4a9eff; color: white; }
    .secondary { background: #eef2f7; color: #1f2933; }
    .danger { background: #e35d6a; color: white; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .endpoint { background: #f3f7ff; border: 1px solid #d9e7ff; padding: 12px 14px; border-radius: 10px; font-family: monospace; font-size: 13px; word-break: break-all; }
    .status-bar { display: flex; align-items: center; gap: 10px; padding: 12px 14px; background: #f8fafc; border: 1px solid #e5ecf3; border-radius: 10px; margin-top: 22px; }
    .indicator { display: inline-flex; align-items: center; gap: 8px; padding: 6px 10px; border-radius: 999px; font-weight: 600; }
    .indicator .dot { width: 10px; height: 10px; border-radius: 50%; }
    .online { background: #e8f7ef; color: #1b6e34; }
    .online .dot { background: #22c55e; }
    .offline { background: #fdf2f2; color: #b42318; }
    .offline .dot { background: #f75555; }
    .icon-button { background: #eef2f7; color: #1f2933; width: 36px; height: 36px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-weight: bold; }
    .message { flex: 1; color: #1f2933; font-size: 13px; min-height: 18px; }
    .pill { display: inline-block; padding: 6px 10px; border-radius: 999px; background: #eef2f7; font-size: 12px; margin-left: 6px; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Puter Local Model Emulator</h1>
      <p class="muted">Configure the OpenAI-compatible endpoint backed by Puter AI.</p>
    </header>

    <div class="section">
      <label>Saved Configuration <span class="muted" style="font-weight:400">Load or save presets</span></label>
      <div class="row">
        <select id="preset-select">
          <option value="">-- No preset selected --</option>
        </select>
        <button id="preset-action" class="secondary">Save</button>
      </div>
    </div>

    <div class="section">
      <label>Puter Model</label>
      <div class="row">
        <input type="text" id="model-select" list="puter-models-list" placeholder="Search or select a Puter model...">
        <datalist id="puter-models-list"></datalist>
        <button id="refresh-models" class="secondary">Refresh Models</button>
      </div>
    </div>

    <div class="section">
      <label>Spoofed OpenAI Model ID</label>
      <div class="row">
        <input type="text" id="spoofed-model" list="common-models" placeholder="Search or select a model to spoof...">
        <datalist id="common-models">
          <option value="gpt-4o">OpenAI GPT-4o</option>
          <option value="claude-3-5-sonnet-20241022">Anthropic Claude 3.5 Sonnet</option>
          <option value="gemini-1.5-pro">Google Gemini 1.5 Pro</option>
          <option value="llama-3.3-70b-instruct">Meta Llama 3.3 70B</option>
          <option value="mistral-large-latest">Mistral Large</option>
          <option value="command-r-plus">Cohere Command R+</option>
          <option value="grok-2">xAI Grok 2</option>
          <option value="deepseek-chat">DeepSeek Chat</option>
          <option value="qwen-max">Alibaba Qwen Max</option>
          <option value="jamba-1.5-large">AI21 Jamba 1.5</option>
        </datalist>
        <button id="start-stop" class="primary">Start</button>
      </div>
    </div>

    <div class="status-bar">
      <div id="puter-indicator" class="indicator offline">
        <span class="dot"></span>
        <span class="indicator-text">Puter Offline</span>
      </div>
      <div id="emulator-pill" class="pill">Emulator stopped</div>
      <button id="refresh-health" class="icon-button" title="Refresh status">‚ü≥</button>
      <div id="status-message" class="message"></div>
    </div>
  </div>

  <script>
    const presetSelect = document.getElementById('preset-select');
    const presetActionBtn = document.getElementById('preset-action');
    const modelSelect = document.getElementById('model-select');
    const modelDatalist = document.getElementById('puter-models-list');
    const refreshModelsBtn = document.getElementById('refresh-models');
    const spoofedInput = document.getElementById('spoofed-model');
    const startStopBtn = document.getElementById('start-stop');
    const indicatorEl = document.getElementById('puter-indicator');
    const indicatorText = indicatorEl.querySelector('.indicator-text');
    const emulatorPill = document.getElementById('emulator-pill');
    const refreshHealthBtn = document.getElementById('refresh-health');
    const statusMessage = document.getElementById('status-message');

    const BLOCKED_MODELS = ['abuse', 'costly', 'fake', 'model-fallback-test-1', 'usage-limited'];
    let presets = [];
    let models = [];
    let emulatorActive = false;
    let puterOnline = false;

    function setMessage(text) {
      statusMessage.textContent = text || '';
    }

    function setIndicator(online) {
      puterOnline = online;
      indicatorEl.classList.toggle('online', online);
      indicatorEl.classList.toggle('offline', !online);
      indicatorText.textContent = online ? 'Puter Online' : 'Puter Offline';
    }

    function setEmulatorState(active) {
      emulatorActive = active;
      emulatorPill.textContent = active ? 'Emulator running' : 'Emulator stopped';
      startStopBtn.textContent = active ? 'Stop' : 'Start';
      startStopBtn.classList.toggle('danger', active);
      startStopBtn.classList.toggle('primary', !active);
    }

    function ensureModelInSelect(modelId) {
      if (!modelId || BLOCKED_MODELS.includes(modelId)) return;
      const exists = Array.from(modelDatalist.options).some(opt => opt.value === modelId);
      if (!exists) {
        const opt = document.createElement('option');
        opt.value = modelId;
        opt.label = `${modelId} (cached)`;
        modelDatalist.appendChild(opt);
      }
    }

    function populateModels(selectedId) {
      modelDatalist.innerHTML = '';
      const availableModels = models.filter(model => !BLOCKED_MODELS.includes(model.id));

      if (!availableModels.length) {
        modelSelect.value = '';
        return;
      }

      availableModels.forEach(model => {
        const opt = document.createElement('option');
        opt.value = model.id;
        opt.label = model.label || model.id;
        modelDatalist.appendChild(opt);
      });

      if (selectedId && availableModels.some(m => m.id === selectedId)) {
        modelSelect.value = selectedId;
      } else if (!modelSelect.value && availableModels[0]) {
        modelSelect.value = availableModels[0].id;
      }
    }

    function populatePresets(selectedId) {
      presetSelect.innerHTML = '<option value="">-- No preset selected --</option>';
      presets.forEach(preset => {
        const opt = document.createElement('option');
        opt.value = preset.id;
        opt.textContent = preset.name;
        presetSelect.appendChild(opt);
      });

      if (selectedId) {
        presetSelect.value = selectedId;
      }

      presetActionBtn.textContent = presetSelect.value ? 'Edit' : 'Save';
    }

    function applyPreset(presetId) {
      const preset = presets.find(p => p.id === presetId);
      if (!preset) return;
      ensureModelInSelect(preset.puterModelId);
      modelSelect.value = preset.puterModelId;
      spoofedInput.value = preset.spoofedOpenAIModelId || '';
      presetActionBtn.textContent = 'Edit';
      setMessage(`Loaded preset "${preset.name}"`);
    }

    async function fetchState(force = false) {
      const res = await fetch(`/config/state${force ? '?force=true' : ''}`);
      if (!res.ok) throw new Error('Failed to load state');
      return res.json();
    }

    async function saveConfig() {
      const body = {
        puterModelId: modelSelect.value,
        spoofedOpenAIModelId: spoofedInput.value
      };
      await fetch('/config/save', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
    }

    async function handleStartStop() {
      const puterModelId = modelSelect.value;
      if (!puterModelId) {
        setMessage('Select a Puter model first.');
        return;
      }

      startStopBtn.disabled = true;
      try {
        if (emulatorActive) {
          const res = await fetch('/emulator/stop', { method: 'POST' });
          const data = await res.json();
          if (data.success) {
            setEmulatorState(false);
            setMessage('Emulator stopped.');
          } else {
            setMessage(data.error || 'Failed to stop emulator.');
          }
        } else {
          await saveConfig();
          const res = await fetch('/emulator/start', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ puterModelId, spoofedOpenAIModelId: spoofedInput.value })
          });
          const data = await res.json();
          if (data.success) {
            setEmulatorState(true);
            setIndicator(true);
            setMessage('Emulator started.');
          } else {
            setMessage(data.error || 'Failed to start emulator.');
          }
        }
      } catch (err) {
        setMessage(err.message);
      } finally {
        startStopBtn.disabled = false;
      }
    }

    async function refreshModels(force = false) {
      refreshModelsBtn.disabled = true;
      try {
        const res = await fetch(`/models${force ? '?force=true' : ''}`);
        const data = await res.json();
        models = data.models || [];
        populateModels(modelSelect.value);
        setIndicator(data.puterOnline !== false);
        setMessage(force ? 'Models refreshed from Puter.' : 'Models loaded.');
      } catch (err) {
        setMessage('Failed to load models: ' + err.message);
      } finally {
        refreshModelsBtn.disabled = false;
      }
    }

    async function refreshHealth() {
      try {
        const res = await fetch('/health');
        const data = await res.json();
        setIndicator(data.online === true);
        setMessage(data.message || 'Health checked.');
      } catch (err) {
        setIndicator(false);
        setMessage('Unable to reach Puter: ' + err.message);
      }
    }

    async function savePreset(existingId) {
      const name = prompt(existingId ? 'Rename preset' : 'Preset name');
      if (!name) return;
      const body = {
        id: existingId || undefined,
        name: name.trim(),
        puterModelId: modelSelect.value,
        spoofedOpenAIModelId: spoofedInput.value
      };
      const res = await fetch('/config/savePreset', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
      const data = await res.json();
      if (data.success) {
        if (existingId) {
          presets = presets.map(p => p.id === existingId ? data.preset : p);
          populatePresets(existingId);
          setMessage('Preset updated.');
        } else {
          presets.push(data.preset);
          populatePresets(data.preset.id);
          setMessage('Preset saved.');
        }
      } else {
        setMessage(data.error || 'Failed to save preset.');
      }
    }

    async function init() {
      try {
        const state = await fetchState();
        presets = state.presets || [];
        models = state.models || [];
        populatePresets();
        populateModels(); // Don't auto-select, let user choose
        // Don't auto-fill spoofed model field - let user choose
        setEmulatorState(state.emulatorActive);
        setIndicator(state.puterOnline !== false);
        setMessage('Ready.');
        await refreshHealth();
      } catch (err) {
        setMessage('Failed to load state: ' + err.message);
      }
    }

    presetSelect.addEventListener('change', () => {
      if (presetSelect.value) {
        applyPreset(presetSelect.value);
      }
      presetActionBtn.textContent = presetSelect.value ? 'Edit' : 'Save';
    });

    presetActionBtn.addEventListener('click', () => {
      if (presetSelect.value) {
        savePreset(presetSelect.value);
      } else {
        savePreset();
      }
    });

    refreshModelsBtn.addEventListener('click', () => refreshModels(true));
    startStopBtn.addEventListener('click', handleStartStop);
    refreshHealthBtn.addEventListener('click', refreshHealth);

    init();
  </script>
</body>
</html>
